# FPtoINT 模块规格说明书

## 1. 概述

FPtoINT模块实现浮点数到整数的类型转换功能，支持IEEE 754标准的16位和32位浮点数转换为16位和32位有符号整数。

## 2. 设计目标

### 2.1 功能目标

- 支持FP16和FP32到INT16和INT32的转换
- 实现子字并行处理能力
- 提供饱和处理机制
- 正确处理IEEE 754特殊值

### 2.2 性能目标

- 零延迟组合逻辑实现
- 支持4路并行处理
- 高资源利用效率

## 3. 接口规格

### 3.1 微指令接口

| 信号名称 | 位宽 | 方向 | 描述 |
|---------|------|------|------|
| inst_vld | 1 | 输入 | 指令有效信号 |
| src_prec | 1 | 输入 | 源精度：0=FP16, 1=FP32 |
| dst_prec | 1 | 输入 | 目的精度：0=INT16, 1=INT32 |
| src_pos | 1 | 输入 | 源数据位置：0=低位, 1=高位 |
| dst_pos | 1 | 输入 | 目的数据位置：0=低位, 1=高位 |

### 3.2 数据接口

| 信号名称 | 位宽 | 方向 | 描述 |
|---------|------|------|------|
| clk | 1 | 输入 | 时钟输入 |
| rst_n | 1 | 输入 | 低有效复位 |
| dvr_fptoint_s_in | 128 | 输入 | 输入数据寄存器 |
| cru_fptoint_in | 5 | 输入 | 上行指令寄存器 |
| dr_fptoint_d_out | 128 | 输出 | 输出数据寄存器 |

## 4. 功能规格

### 4.1 转换模式

| 源格式 | 目的格式 | 处理方式 |
|--------|----------|----------|
| FP32 | INT32 | 直接转换，溢出饱和 |
| FP32 | INT16 | 转换后截断饱和 |
| FP16 | INT32 | 转换后符号扩展 |
| FP16 | INT16 | 直接转换，溢出饱和 |

### 4.2 子字并行模式

>即8路FP16转INT16模式

当 `src_prec=0` 且 `dst_prec=0` 时：

- 输入32位包含2个FP16数据：[31:16]和[15:0]
- 并行转换为2个INT16结果
- 输出32位包含2个INT16数据：[31:16]和[15:0]

### 4.3 特殊值处理

| 输入值 | 输出行为 |
|--------|----------|
| +∞ | 饱和到最大正整数 |
| -∞ | 饱和到最大负整数 |
| NaN | 饱和到最大正整数 |
| ±0 | 输出0 |
| 非规格化数 | 输出0 |

## 5. 饱和处理规格

### 5.1 INT16范围

- 有符号范围：-32768 ~ 32767
- 超出范围时饱和到边界值

### 5.2 INT32范围

- 有符号范围：-2147483648 ~ 2147483647
- 超出范围时饱和到边界值

## 6. 精度规格

### 6.1 舍入模式

- 采用截断模式（向零舍入）
- 符合IEEE 754-2008标准

### 6.2 精度损失

- FP32→INT16：可能损失精度和范围
- FP16→INT32：保持所有精度
- 其他转换：根据格式特性处理

## 7. 时序规格

### 7.1 延迟特性

- 组合逻辑实现：0时钟延迟
- 输入变化到输出稳定：< 10ns（典型值）

### 7.2 建立保持时间

- 符合标准CMOS工艺要求
- 建立时间：2ns（典型）
- 保持时间：1ns（典型）

## 8. 资源利用规格

### 8.1 逻辑资源（单个单元）

- 组合逻辑门：约500个等效门
- 多路选择器：大量MUX资源
- 无时序逻辑元件

### 8.2 阵列资源（4单元）

- 逻辑门：约2000个等效门
- 并行度：4路完全并行
- 资源复用：控制逻辑共享

## 9. 测试规格

### 9.1 功能测试覆盖

- ✓ 所有转换模式组合
- ✓ 特殊值处理
- ✓ 边界值测试
- ✓ 子字并行模式
- ✓ 位置控制功能
- ✓ 指令有效性控制

### 9.2 性能验证

- ✓ 4路并行正确性
- ✓ 零延迟特性
- ✓ 饱和处理正确性

## 10. 合规性

### 10.1 标准符合性

- IEEE 754-2008浮点数标准
- 截断舍入模式
- 特殊值处理规范

### 10.2 设计约束

- 纯组合逻辑设计
- 无时钟依赖
- 适合流水线集成

## 11. 使用限制

### 11.1 输入约束

- 浮点数必须符合IEEE 754格式
- 无效的位模式行为未定义

### 11.2 性能限制

- 关键路径较长，可能限制时钟频率
- 建议在高频设计中考虑流水线

## 12. 扩展性

### 12.1 模块化设计

- 单元可独立使用
- 支持任意数量阵列扩展
- 控制接口标准化

### 12.2 未来增强

- 支持更多舍入模式
- 支持无符号整数输出
- 支持其他浮点格式（bfloat16等）
