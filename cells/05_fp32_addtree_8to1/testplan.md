# FP32加法器树验证测试计划

## 1. 引言

本测试计划基于实际实现的测试台 `tb_fp32_adder_tree_8_inputs.v`，详细描述了8输入FP32加法器树的验证策略、测试用例和验证方法。测试台使用SoftFloat库作为参考模型，确保IEEE-754标准的严格合规性。

## 2. 设计概述

### 2.1 被测设计 (DUT)
- **模块名称**: `fp32_adder_tree_8_inputs`
- **输入**: 
  - `clk`: 时钟信号
  - `rst_n`: 低电平有效复位信号
  - `dvr_fp32addtree8to1_s0[127:0]`: 计算输入数据0（8个FP32数的低16位）
  - `dvr_fp32addtree8to1_s1[127:0]`: 计算输入数据1（8个FP32数的高16位）
  - `cru_fp32addtree8to1[2:0]`: 上行指令寄存器
- **输出**: 
  - `dr_fp32addtree8to1_d[127:0]`: 输出数据寄存器

### 2.2 设计特性
- **IEEE-754兼容**: 严格遵循IEEE-754浮点标准
- **特殊值处理**: 支持NaN、±∞、±0、非规格化数处理
- **指令控制**: 通过指令寄存器控制计算启动和结果存储位置

### 2.3 接口协议
- **输入数据格式**: 8个FP32数据通过两个128位寄存器传入
  - 每个FP32数据分为高16位（存储在S1寄存器）和低16位（存储在S0寄存器）
  - FP32[i] = {S1[i], S0[i]}，其中i为0到7
- **指令格式**: `cru_fp32addtree8to1[2:0]`
  - bit[2]: 指令有效位
  - bit[1:0]: 目的寄存器索引（结果存储位置）
- **输出格式**: 计算结果存储在输出寄存器的指定位置

## 3. 验证目标

1. **功能正确性**: 使用SoftFloat参考模型验证8个FP32数加法的正确性
2. **IEEE-754合规性**: 验证舍入、异常处理符合IEEE-754标准
3. **特殊值处理**: 验证NaN、无穷大、零值的正确处理
4. **精度验证**: 验证舍入精度和ULP(Unit in Last Place)误差控制
5. **边界条件**: 验证数值边界和极值情况的正确行为

## 4. 验证环境

### 4.1 测试台架构
```
SystemVerilog测试台 (tb_fp32_adder_tree_8_inputs.v)
├── DPI-C接口 → SoftFloat参考模型 (C语言)
├── 固定测试用例 (41个预定义用例)
├── 随机测试 (100,000次约束随机测试)
├── 时序控制 → 时钟生成和复位控制
└── 结果比较与统计
```

### 4.2 SoftFloat参考模型
- **库版本**: Berkeley SoftFloat-3
- **舍入模式**: IEEE-754近似偶数舍入 (ROUND_NEAR_EVEN)
- **异常检测**: 支持5种IEEE-754异常标志检测
  - `inexact` (0x01): 不精确结果
  - `underflow` (0x02): 下溢
  - `overflow` (0x04): 上溢  
  - `div_zero` (0x08): 除零 (本设计不适用)
  - `invalid` (0x10): 无效操作

### 4.3 验证方法
- **DPI-C接口**: SystemVerilog与C语言SoftFloat库的无缝集成
- **ULP容差检查**: 允许最多8 ULP的不精确误差
- **随机种子**: 使用固定种子17656确保测试可重现
- **时序控制**: 通过时钟周期控制测试的执行时序
## 5. 测试场景

### 5.1 固定测试用例 (41个预定义测试)

基于实际测试台实现，包含以下四大类测试场景：

#### 5.1.1 基本功能测试 (测试用例 0-3)

| 测试ID | 测试内容 | 输入描述 | 预期结果 |
|--------|---------|---------|---------|
| TC-00 | 基本正数加法 | 1.0+2.0+3.0+4.0+5.0+6.0+7.0+8.0 | 36.0 |
| TC-01 | 正负数混合加法 | ±10.0, ±5.0, ±1.0, ±2.0 组合 | 0.0 (精确抵消) |
| TC-02 | 全正零测试 | 8个 +0.0 | +0.0 |
| TC-03 | 全负零测试 | 8个 -0.0 | -0.0 |

#### 5.1.2 特殊值测试 (测试用例 4-7)

| 测试ID | 测试内容 | 输入描述 | 预期结果 |
|--------|---------|---------|---------|
| TC-04 | 正负零混合 | 交替的+0.0和-0.0 | 根据IEEE-754规则确定符号 |
| TC-05 | 正无穷测试 | +∞ + 7个1.0 | +∞, is_inf_out=1 |
| TC-06 | 负无穷测试 | -∞ + 7个1.0 | -∞, is_inf_out=1 |
| TC-07 | NaN传播测试 | qNaN + 7个1.0 | NaN, is_nan_out=1 |

#### 5.1.3 精度与边界测试 (测试用例 8-39)

| 测试组 | 测试ID | 测试内容 | 关键特性 |
|-------|--------|---------|---------|
| **数值范围** | TC-08 | 最小正规格化数 (0x00800000) × 8 | 边界值处理 |
| | TC-09 | 最大正规格化数 (0x7F7FFFFF) × 8 | 可能上溢检测 |
| | TC-10 | 最小非规格化数 (0x00000001) × 8 | 非规格化数处理 |
| | TC-11 | 小非规格化数 (0x00000100) × 8 | 精度保持 |
| | TC-12 | 大数值 (0x7F000000) × 8 | 大数加法 |
| | TC-13 | 0.5 × 8 | 精确结果验证 |
| **精度测试** | TC-14 | 接近1.0的数值差异 | ULP精度验证 |
| | TC-15 | 0.25 × 8 | 小数精度 |
| | TC-16 | 几何级数 (1,2,4,8,16,32,64,128) | 不同量级相加 |
| | TC-17 | 极小正数 (0x34000000) × 8 | 精度极限测试 |
| **符号与误差** | TC-18 | 正负混合近零结果 | 符号确定性 |
| | TC-19 | 非规格化数 (0x00000010) × 8 | 非规格化运算 |
| | TC-20-30 | 小数系列测试 | 0.1, 0.2, 0.3, 0.4, 0.6-0.9等 |
| **边界情况** | TC-31 | 交替±1.0 | 符号交替 |
| | TC-32 | 全-1.0 | 负数累加 |
| | TC-33 | 大指数差 (65536.0 vs 1.0) | 指数对齐极限 |
| | TC-34 | 数学常数 (π/8) | 特殊值验证 |
| | TC-35 | 数学常数 (e/8) | 超越数处理 |

#### 5.1.4 溢出测试 (测试用例 40)

| 测试ID | 测试内容 | 输入描述 | 预期结果 |
|--------|---------|---------|---------|
| TC-40 | 上溢测试 | 8个最大正规格化数 (0x7F7FFFFF) | +∞, is_inf_out=1 |

### 5.2 随机测试

#### 5.2.1 随机测试配置
- **测试数量**: 100,000次完全随机测试
- **随机种子**: 17656 (固定种子保证可重现性)
- **输入范围**: 全IEEE-754 FP32值域
- **统计输出**: 每5个测试输出一次详细结果

#### 5.2.2 随机测试策略
- **完全随机性**: 使用SystemVerilog `$random`函数生成
- **无约束覆盖**: 覆盖所有可能的FP32值组合
- **统计分析**: 
  - 通过率统计
  - 失败用例自动记录
  - 输入值详细日志

### 5.3 验证判据

#### 5.3.1 结果比较算法
```verilog
// 实际实现的比较逻辑
function compare_results;
    input [31:0] expected;    // SoftFloat参考结果
    input [31:0] actual;      // DUT实际结果
    input [31:0] flags;       // SoftFloat异常标志
    
    // 1. NaN vs NaN: 接受
    // 2. 精确匹配: 接受  
    // 3. 不精确结果: 允许≤8 ULP误差
    // 4. 精确结果: 要求零误差
endfunction
```

#### 5.3.2 容差标准
- **精确结果**: 零ULP误差要求
- **不精确结果**: 最多8 ULP误差容忍
- **NaN处理**: 任意NaN等价
- **特殊值**: 严格匹配要求


## 6. 验证流程与自动化

### 6.1 测试执行流程

```
1. 环境初始化
   ├── 时钟和复位信号初始化
   ├── SoftFloat舍入模式设置 (ROUND_NEAR_EVEN)
   └── 测试用例数据初始化

2. 固定测试用例执行 (41个测试)
   ├── 基本功能测试 → 特殊值测试 → 精度测试 → 溢出测试
   ├── 每个测试流程:
   │   ├── 设置输入寄存器: dvr_fp32addtree8to1_s0/s1
   │   ├── 设置指令寄存器: cru_fp32addtree8to1 (cmd_valid=1)
   │   ├── 等待时钟周期让DUT处理
   │   ├── 从输出寄存器读取结果: dr_fp32addtree8to1_d
   │   ├── SoftFloat参考计算
   │   └── 结果比较和验证
   └── 统计: 通过/失败计数

3. 随机测试执行 (100,000次)
   ├── 随机输入生成 (种子: 17656)
   ├── 时序控制下的测试流程:
   │   ├── 随机FP32数据组装到输入寄存器
   │   ├── 指令寄存器设置启动计算
   │   ├── 时钟周期控制下等待DUT计算
   │   ├── 并行进行SoftFloat参考计算
   │   └── 从输出寄存器提取结果比较
   └── 结果比较与选择性日志记录

4. 结果统计与报告
   ├── 总体通过率计算
   ├── 失败用例详细记录
   └── 仿真状态输出 (PASS/FAIL)
```

### 6.2 自动化特性

#### 6.2.1 测试管理
- **自动化测试用例管理**: 41个固定测试用例的自动初始化和执行
- **随机测试控制**: 可配置的随机测试数量和种子
- **智能日志记录**: 随机测试的选择性输出（每5个测试记录一次）

#### 6.2.2 结果验证
- **异常标志检测**: 自动检测和分析5种IEEE-754异常
- **ULP误差计算**: 自动计算和验证ULP误差范围（≤8 ULP）
- **特殊值识别**: 自动识别和验证NaN、Inf等特殊值
- **寄存器接口控制**: 自动管理输入输出寄存器和指令控制

#### 6.2.3 报告生成
- **实时统计**: 测试过程中的实时通过/失败统计
- **详细日志**: 失败用例的完整输入输出记录
- **格式化输出**: 结构化的测试结果报告

### 6.3 调试支持

#### 6.3.1 波形生成
```verilog
`ifdef DUMP_FSDB
    $fsdbDumpfile("sim_softfloat.fsdb");
    $fsdbDumpvars(0, tb_fp32_adder_tree_8_inputs);
`endif
```

#### 6.3.2 失败分析
- **输入值记录**: 失败测试用例的完整输入值十六进制记录
- **期望vs实际**: 详细的SoftFloat期望值与DUT实际值对比
- **异常标志**: 详细的异常标志状态分析

## 7. 验证覆盖率与质量保证

### 7.1 功能覆盖点

基于实际测试台实现的覆盖点：

| 覆盖组 | 覆盖点 | 测试方法 | 覆盖状态 |
|-------|-------|---------|---------|
| **输入值类型** | 正规格化数 | 固定+随机测试 | ✓ |
| | 非规格化数 | TC-08,10,11,19 | ✓ |
| | 正零/负零 | TC-02,03,04 | ✓ |
| | 正无穷/负无穷 | TC-05,06 | ✓ |
| | NaN | TC-07 | ✓ |
| **数值范围** | 最小值 | TC-08,10 | ✓ |
| | 最大值 | TC-09,40 | ✓ |
| | 中等值 | TC-00,15,16 | ✓ |
| **指数差异** | 零指数差 | TC-02,03,08-13 | ✓ |
| | 大指数差 | TC-33 | ✓ |
| | 混合指数 | TC-16 | ✓ |
| **符号组合** | 全正数 | TC-00,08-13 | ✓ |
| | 全负数 | TC-32 | ✓ |
| | 正负混合 | TC-01,18,31 | ✓ |
| **特殊情况** | 精确抵消 | TC-01 | ✓ |
| | 溢出 | TC-40 | ✓ |
| | 舍入边界 | 随机测试覆盖 | ✓ |

### 7.2 验证质量指标

- **固定测试覆盖**: 41个精心设计的测试用例
- **随机测试强度**: 100,000次完全随机测试
- **异常检测覆盖**: 4种IEEE-754异常全面验证
- **精度验证**: 8 ULP容差的严格精度控制
- **可重现性**: 固定随机种子确保测试可重现

## 8. 预期验收标准

### 8.1 功能正确性
- ✅ **固定测试**: 所有41个固定测试用例必须通过
- ✅ **随机测试**: 100,000次随机测试通过率 ≥ 99.9%
- ✅ **特殊值**: 所有特殊值(NaN,±∞,±0)处理100%正确

### 8.2 精度要求
- ✅ **精确结果**: 非不精确运算要求零ULP误差
- ✅ **不精确结果**: 不精确运算允许最多8 ULP误差
- ✅ **IEEE-754合规**: 严格遵循IEEE-754舍入和异常规则

### 8.3 性能指标
- ✅ **时序设计**: 满足时钟周期的建立保持时间要求
- ✅ **寄存器接口**: 正确的寄存器读写时序
- ✅ **仿真效率**: 完整测试在合理时间内完成
- ✅ **调试友好**: 完整的失败分析和波形支持

