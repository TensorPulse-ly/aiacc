
# LDB (Burst Load Unit) 测试计划 (ldb_testplan.md)

### 1. 引言
本计划覆盖 LDB 控制器的全功能测试，重点验证其 AXI 协议交互的正确性、突发传输的完整性、字节使能功能的准确性以及状态机的稳健性。

### 2. 验证目标
| 目标类别 | 描述 |
| :--- | :--- |
| **功能正确性** | 从指令解析到 UR 写入的整个数据通路正确 |
| **协议符合性** | 严格遵守 AXI4 读通道时序协议，无违规 |
| **字节使能** | 16 种字节掩码模式在最后一拍数据正确应用 |
| **地址序列** | 全局地址和 UR 地址按预期递增 |
| **状态机覆盖** | 完整遍历状态机所有状态和转换路径 |
| **错误处理** | 对 AXI 传输错误和超时进行正确响应 |
| **覆盖率** | ldb.v代码行覆盖 ≥95% |

### 3. 测试方法
| 方法 | 工具/实现 |
| :--- | :--- |
| **定向测试** | 编写特定测试序列，覆盖所有操作码和边界情况 |
| **协议检查** | 内联 `axi_protocol_checker` 实时监测 AXI 总线 |
| **波形分析** | 使用 VCS/Verdi 分析关键时序和数据流 |
| **内存比对** | 比较写入 URAM 的数据与预期值 |
| **覆盖率收集** | VCS/URG 生成覆盖率报告 |

### 4. 测试场景
**4.1 基础功能测试**
| ID | 场景 | 输入示例 / 验证点 |
| :--- | :--- | :--- |
| **BF-01** | 单拍传输 (全使能) | `brst=2`, `byte_strb=0`。验证：正确发起 1-length AXI 突发，UR 写入 1 次，数据完整。 |
| **BF-02** | 多拍传输 (全使能) | `brst=4`。验证：正确发起 3-length AXI 突发，UR 写入 4 次，地址连续递增。 |
| **BF-03** | 指令直通 | 验证 `cru_ldb_o` 始终等于 `cru_ldb_i`。 |

**4.2 字节使能测试**
| ID | 场景 | 输入示例 / 验证点 |
| :--- | :--- | :--- |
| **BE-01** | 全字节使能 (`4'h0`) | 验证最后一拍数据 `ur_wdata` 与 `axi_data` 完全一致。 |
| **BE-02** | 部分使能 (如 `4'h1`) | 验证 `ur_wdata` 仅最低字节被更新，其他字节为 0 或保持（取决于设计）。 |
| **BE-03** | 所有使能模式遍历 | 循环测试 `byte_strb` 从 `4'h0` 到 `4'hF`，验证掩码应用正确。 |

**4.3 AXI 协议与错误测试**
| ID | 场景 | 验证点 |
| :--- | :--- | :--- |
| **AX-01** | AR 握手时序 | 验证 `arvalid` 在 `arready` 前保持，握手后撤销。 |
| **AX-02** | R 握手与 `rlast` | 验证 `rlast` 仅在最后一拍数据时为 1。 |
| **AX-03** | 协议错误注入 | 在 Slave 模型中注入 `rresp=2'b10` (SLVERR)，验证 LDB 能否检测并通过 `axi_req_err` 上报。 |
| **AX-04** | 超时测试 | 模拟 `arready` 或 `rvalid` 始终为 0，验证超时机制能否使状态机安全恢复。 |

**4.4 状态机与边界测试**
| ID | 场景 | 验证点 |
| :--- | :--- | :--- |
| **ST-01** | 连续加载 | 发送完一个指令包后立即发送下一个，验证状态机能否正确回到 `IDLE` 并重新开始。 |
| **ST-02** | 复位测试 | 在传输过程中触发复位 `rst_n=0`，验证所有寄存器是否清零，状态机是否回到 `IDLE`。 |
| **ST-03** | 零长突发* | `brst=1` (或 `0`)。检查是否被正确处理或拒绝。*(需确认规格是否允许)* |

### 5. 验证环境
| 工具 | 用途 |
| :--- | :--- |
| **VCS** | RTL 编译、仿真、覆盖率收集 |
| **Verdi** | 波形查看与调试 |
| **URG** | 生成覆盖率报告 |
| **自定义 AXI Slave** | `axi_read_mem_slave.v`，提供预置内存数据并支持错误注入 |
| **自定义 AXI Checker** | `axi_protocol_checker.v`，在线协议检查 |

### 6. 回归策略
-   任何对 `ldb.v` 或 `axi_top.v` 的修改都必须触发核心测试集 (BF-01, BF-02, BE-03, AX-02)。
-   新增功能需添加对应的测试用例并加入回归集。
-   覆盖率下降则阻塞代码提交。

### 7. 验收标准
| 指标 | 要求 |
| :--- | :--- |
| **功能通过率** | 100% |
| **协议违规** | 0 |
| **行覆盖率** | ≥95% |
| **分支覆盖率** | ≥95% |

### 附录：关键覆盖点
| 覆盖组 | 覆盖目标 |
| :--- | :--- |
| **状态机状态** | `IDLE`, `PARSE`, `WAIT_AXI`, `DATA`, `DONE` |
| **状态机转换** | 绝大多数可能的状态转换路径（排除错误转换） |
| **字节使能** | `byte_strb` 16 种取值 |
| **突发长度** | 短突发 (len=1), 典型突发 (e.g., len=4), 长突发 (len>100) |
| **AXI 响应** | `rresp` 为 `OKAY` 和 `SLVERR` (如果支持错误注入) |
| **握手超时** | `arvalid` 或 `rvalid` 超时路径 |

> ✅ 通过执行 `./run_sim.sh` 一键验证（需预先配置 VCS 环境）