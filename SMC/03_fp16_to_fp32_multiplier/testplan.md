# FP16转FP32乘法器测试计划

## 测试目标

验证FP16到FP32浮点乘法器的功能正确性、性能指标和边界条件处理能力。

## 测试环境

- **仿真器**: Synopsys VCS
- **验证方法**: DPI-C接口调用Berkeley SoftFloat库作为参考模型
- **时钟频率**: 100MHz (10ns周期)
- **舍入模式**: IEEE 754就近舍入到偶数模式

## 测试分类

### 1. 功能验证测试

#### 1.1 基本运算测试 (fixed_test)
**测试目的**: 验证基本FP16乘法运算的正确性

**测试用例**:
- 规格化数乘法
  - 1.0 × 1.0 = 1.0
  - 2.0 × 1.0 = 2.0  
  - 4.0 × 4.0 = 16.0
  - 4.0 × 1.5 = 6.0
  - 0.5 × 0.5 = 0.25

- 负数乘法
  - -1.0 × -1.0 = 1.0
  - 4.0 × -2.0 = -8.0
  - 64.0 × 64.0 = 4096.0

- 边界值测试
  - max_norm × 1.0
  - min_norm × 1.0
  - min_norm × min_norm (结果为非规格化数)

**预期结果**: 所有测试用例的输出与SoftFloat库完全一致

#### 1.2 特殊值处理测试
**测试目的**: 验证IEEE 754特殊值的正确处理

**测试用例**:
- 无穷大运算
  - +∞ × 1.0 = +∞
  - +∞ × +∞ = +∞  
  - -∞ × +∞ = -∞
  - +∞ × 0 = NaN

- NaN传播
  - NaN × 1.0 = NaN
  - 1.0 × NaN = NaN
  - NaN × ∞ = NaN

- 零值运算
  - +0 × 1.0 = +0
  - +0 × -0 = -0
  - -0 × 1.0 = -0

- 非规格化数
  - min_denorm × 1.0
  - max_denorm × 1.0
  - min_denorm × min_denorm (下溢到零)

**预期结果**: 所有特殊值按IEEE 754标准正确处理

#### 1.3 溢出和下溢测试
**测试目的**: 验证数值范围边界的处理

**测试用例**:
- 上溢测试
  - max_norm × max_norm → +∞
  - 2^15 × 2^15 = +∞

- 下溢测试  
  - min_norm × min_norm → 非规格化数
  - 极小值相乘 → 零

**预期结果**: 溢出产生无穷大，下溢产生零或非规格化数

### 2. 寄存器操作测试

#### 2.1 单组寄存器测试 (test_with_softfloat)
**测试目的**: 验证单个组的寄存器读写和计算

**测试流程**:
1. 写入FP16_A到S0-S3寄存器指定组
2. 写入FP16_B到S4-S7寄存器指定组  
3. 发起乘法指令
4. 读取并验证结果

**测试组合**:
- 组ID: 0-31 (覆盖所有32组)
- 寄存器组: 0和1 (测试双缓冲机制)

#### 2.2 寄存器组交叉测试 (test_all_bank_combinations)
**测试目的**: 验证不同寄存器组之间的交叉操作

**测试矩阵**:
- S0-S3寄存器组0 × S4-S7寄存器组0
- S0-S3寄存器组0 × S4-S7寄存器组1
- S0-S3寄存器组1 × S4-S7寄存器组0
- S0-S3寄存器组1 × S4-S7寄存器组1

**预期结果**: 所有组合都能正确选择相应的寄存器组进行计算

#### 2.3 无效指令测试 (test_idle_instruction)
**测试目的**: 验证无效控制信号不会影响寄存器内容

**测试流程**:
1. 执行有效操作并记录结果
2. 使用无效指令尝试修改
3. 验证结果保持不变

**控制信号测试**:
- cru_fp16mul_s0123[1] = 0 (无效S0-S3写入)
- cru_fp16mul_s4567[3] = 0 (无效S4-S7写入)  
- cru_fp16mul[2] = 0 (无效乘法指令)

### 3. 并行计算测试

#### 3.1 32组同时随机测试 (test_32groups_simultaneous_random)
**测试目的**: 验证真正的32组同时计算能力和时序正确性

**测试特点**:
- 所有32组数据在同一时钟周期开始计算
- 验证1个时钟周期内完成所有乘法运算
- 强调时序要求和并行性能

**测试流程**:
1. 为所有32组生成随机FP16数据对
2. 将数据组装成128位寄存器格式
3. 按时序写入S0-S3和S4-S7寄存器
4. 发起乘法指令，32组并行计算
5. 验证所有组的计算结果

**测试轮数**: 5轮，每轮32组，共160个测试用例

**预期结果**: 所有组的计算结果与SoftFloat库完全一致

### 4. 随机验证测试

#### 4.1 大量随机测试 (random_test)
**测试目的**: 通过大量随机数据验证设计的鲁棒性

**测试参数**:
- 测试数量: 1000个随机用例
- 数据生成: 完全随机16位数据
- 覆盖范围: 所有可能的FP16值组合

**验证方法**: 每个结果都与SoftFloat库对比验证

### 5. 时序验证测试

#### 5.1 时钟域测试
**测试目的**: 验证所有操作的时序正确性

**关键时序点**:
- 数据写入：必须在时钟上升沿生效
- 指令发起：在时钟上升沿触发计算
- 结果输出：在指令后的第2个时钟周期稳定

#### 5.2 建立保持时间测试
**测试目的**: 验证信号的建立和保持时间要求

**测试方法**:
- 在时钟边沿前后改变输入信号
- 验证不会产生亚稳态或错误结果

## 测试覆盖率目标

### 功能覆盖率
- [ ] IEEE 754所有特殊值类型: 100%
- [ ] 所有32个计算组: 100%
- [ ] 双寄存器组操作: 100%
- [ ] 所有控制信号组合: 100%
- [ ] 舍入模式: 100% (当前仅支持就近舍入)

### 代码覆盖率
- [ ] 行覆盖率: >95%
- [ ] 分支覆盖率: >80%
- [ ] 信号翻转覆盖率: >90%


## 测试执行顺序

根据当前testbench的实现，测试按以下顺序执行：

1. **系统复位** (reset_system)
   - 初始化所有信号
   - 设置SoftFloat舍入模式

2. **固定测试** (fixed_test)
   - 执行38个预定义的测试用例
   - 覆盖基本运算、特殊值、边界条件

3. **无效指令测试** (test_idle_instruction)
   - 验证无效控制信号不影响寄存器内容
   - 测试用例：1.0 × 1.0，组0，寄存器组0

4. **寄存器组交叉测试** (test_all_bank_combinations)
   - 测试所有寄存器组组合
   - 测试数据：1.0×2.0, -1.0×4.0，组0

5. **32组同时随机测试** (test_32groups_simultaneous_random)
   - 5轮测试，每轮32组，共160个测试用例
   - 验证并行计算能力

6. **随机测试** (random_test)
   - XXXX个随机测试用例
   - 全面验证设计鲁棒性

### 测试统计输出
```
=== 测试完成 ===
总测试数: XXXX
通过: XXXX
失败: 0
通过率: 100.0%
*** 所有测试通过! ***
```

## 测试通过标准

### 功能正确性
- 所有固定测试用例通过率: 100%
- 随机测试通过率: 100%
- 与SoftFloat库结果完全一致

### 性能指标
- 32组并行计算: 1个时钟周期内完成
- 最大工作频率: ≥100MHz
- 资源利用率: 在目标器件内


