# FPtoINT 浮点数到整数转换模块（组合逻辑版本）

## 模块概述

FPtoINT模块实现了浮点数到整数的类型转换功能，支持16bit和32bit浮点数转换为16bit和32bit整数。**本设计采用纯组合逻辑实现，具有零延迟特性，实时响应输入变化。**

## 设计特性

### 核心功能

- **FP16 ↔ INT16/INT32**: 支持16位浮点数转换为16位或32位整数
- **FP32 ↔ INT16/INT32**: 支持32位浮点数转换为16位或32位整数
- **子字并行**: 真正的子字并行处理能力（32bit输入包含2个FP16同时转换），实现8路16位浮点数转换为16位整数
- **饱和处理**: 当转换结果超出目标整数类型范围时进行饱和处理
- **特殊值处理**: 正确处理无穷大、NaN、零和非规格化数

### 设计超参数

| 参数名称 | 含义 | V1.0支持 |
|---------|------|----------|
| PARAM-DR-FPtoINT-CNT | FPtoINT的数量 | 4 |
| PARAM-DR-FPtoINT-PREC | FPtoINT的数据精度 | 整数16bit, 整数32bit |
| PARAM-SUBWORD-PARALLELISM | 是否支持子字并行 | 是 |
| PARAM-DIFF-PREC-SD | 是否支持源目的之间数据精度不同 | 支持 |

## 模块架构

### 核心模块

1. **fpto_int.v**: 基础FPtoINT计算单元
   - 支持一个源寄存器到目的寄存器的转换
   - 包含完整的浮点到整数转换逻辑和饱和处理
   - 纯组合逻辑实现，零延迟

2. **fpto_int_array.v**: FPtoINT阵列模块
   - 包含4个并行的FPtoINT单元
   - 统一的微指令控制接口
   - 支持并行处理4路数据

### 微指令格式

| 字段名称 | 位宽 | 含义 |
|---------|------|------|
| 指令有效 | 1 | 1=指令有效, 0=指令无效 |
| 源寄存器精度 | 1 | 0=16bit（FP16）, 1=32bit（FP32） |
| 目的寄存器精度 | 1 | 0=16bit（INT16）, 1=32bit（INT32） |
| 源数据位置 | 1 | 0=低位, 1=高位（仅在源为16bit时有效） |
| 目的数据位置 | 1 | 0=低位, 1=高位（仅在目的为16bit时有效） |

## 转换功能说明

模块实现类似于以下NumPy操作的硬件加速：

```python
# 16位整数转换
DR-FPtoINT-D = DVR-FPtoINT-S.astype(numpy.int16)

# 32位整数转换  
DR-FPtoINT-D = DVR-FPtoINT-S.astype(numpy.int32)
```

### 转换规则

1. **FP16 → INT16**
   - 直接转换，超出范围时饱和处理
   - INT16范围: [-32768, 32767]

2. **FP16 → INT32**
   - 转换为INT16后符号扩展到32位
   - 保持原有精度

3. **FP32 → INT16**
   - 转换为INT32后饱和到INT16范围
   - 超出范围时进行饱和处理

4. **FP32 → INT32**
   - 直接转换，超出范围时饱和处理
   - INT32范围: [-2147483648, 2147483647]

### 特殊值处理

| 输入值 | 输出值 | 说明 |
|--------|--------|------|
| +∞ | 最大正整数 | 正无穷大饱和处理 |
| -∞ | 最大负整数 | 负无穷大饱和处理 |
| NaN | 最大正整数 | NaN按正无穷处理 |
| ±0 | 0 | 零值保持 |
| 非规格化数 | 0 | 简化处理为零 |

## 浮点数格式

### FP32 (IEEE 754)

```
位域: [31] [30:23] [22:0]
      符号   指数   尾数
偏置: 127
```

### FP16 (IEEE 754)

```
位域: [15] [14:10] [9:0]
      符号   指数   尾数
偏置: 15
```

## 子字并行模式

>即8路FP16转INT16模式

当`src_prec=0`且`dst_prec=0`时，启用子字并行模式：

- 输入32位数据被视为2个FP16数据：[31:16]为高位FP16，[15:0]为低位FP16
- 每个FP16数据独立转换为INT16
- 输出32位数据包含2个INT16结果：[31:16]为高位结果，[15:0]为低位结果

## 文件结构

```
vsrc/
├── fpto_int.v              # 基础FPtoINT单元
├── fpto_int_array.v        # 4单元FPtoINT阵列
├── tb_fpto_int.v           # 基础单元测试平台
└── tb_fpto_int_array.v     # 阵列测试平台

csrc/
└── fpto_int_dpi.c          # DPI-C参考实现和验证函数

run_sim.sh                  # 仿真脚本
run_coverage.sh             # 覆盖率报告
README.md                   # 本文档
```

## 仿真与测试

### 运行仿真

```bash
# 给脚本执行权限
chmod +x run_sim.sh
chmod +x run_coverage.sh

# 运行基础单元测试
./run_sim.sh unit

# 运行阵列测试
./run_sim.sh array

# 运行所有测试
./run_sim.sh all

# 生成覆盖率报告
./run_coverage.sh
```

### 测试覆盖范围

#### 基础单元测试 (tb_fpto_int.v)

- FP32转INT32：正负数、零、无穷大、NaN
- FP32转INT16：含饱和处理的转换
- FP16转INT32：符号扩展验证
- FP16转INT16：基础转换
- 子字并行转换：双FP16同时处理
- 数据位置控制：高位/低位处理
- 指令有效性控制
- 边界值和特殊值测试

#### 阵列测试 (tb_fpto_int_array.v)

- 4单元并行转换验证
- 统一控制信号验证
- 并行数据处理
- 阵列级指令控制
- 混合精度转换
- 大批量数据处理

### DPI-C验证

DPI-C文件提供参考实现和自动验证功能：

- 标准浮点数转换参考
- 结果自动对比验证
- 详细的浮点数位域分析
- 特殊值处理验证

## 性能特点

- **零延迟**: 纯组合逻辑实现
- **高吞吐**: 4路并行处理
- **资源高效**: 函数式设计，资源复用
- **精度可配**: 支持多种精度组合

## 设计考虑

1. **精度处理**: 遵循IEEE 754标准的舍入规则
2. **溢出处理**: 采用饱和算术避免回绕
3. **特殊值**: 完整支持IEEE 754特殊值
4. **可扩展性**: 模块化设计便于扩展

## 应用场景

- 深度学习推理引擎
- 数字信号处理系统
- 科学计算加速器
- 图像处理流水线

## 版本历史

- **V1.0**: 初始版本，支持基本的FPtoINT转换功能(*Sunny* 2025/8/20)
- **V1.1**: 修改输入/输出端口，结合子字并行模式与16to16转换，组成8个并行16位整数到16位浮点转换器(*Oliver* 2025/8/24)

## 注意事项

1. 本模块假设输入浮点数符合IEEE 754标准格式
2. 非规格化数被简化处理为零值
3. 舍入策略采用截断模式（向零舍入）
4. 建议在高频应用中考虑流水线优化
