# FPMUL 浮点乘法器技术规格文档

## 1. 概述

### 1.1 模块功能
FPMUL模块是一个支持IEEE 754标准的混合精度浮点乘法器，能够处理FP16（半精度）和FP32（单精度）浮点数乘法运算。

### 1.2 设计目标
- 完全符合IEEE 754-2008浮点标准
- 支持FP16和FP32两种精度格式
- 正确处理所有特殊情况（NaN、无穷大、零、非规格化数）
- 实现精确的舍入机制
- 提供完整的异常处理

## 2. 接口规格

### 2.1 顶层模块接口

```verilog
module fpmul (
    input  wire        inst_valid,           // 指令有效信号：1'b1有效，1'b0无效
    input  wire        src_precision,        // 源寄存器精度：1'b0为16bit，1'b1为32bit
    input  wire        dst_precision,        // 目的寄存器精度：1'b0为16bit，1'b1为32bit
    input  wire [31:0] dvr_fpmul_s0,         // FPMUL第一输入寄存器
    input  wire [31:0] dvr_fpmul_s1,         // FPMUL第二输入寄存器
    output wire [31:0] dr_fpmul_d            // FPMUL输出寄存器
);
```

### 2.2 信号定义

| 信号名 | 位宽 | 方向 | 功能描述 |
|--------|------|------|----------|
| inst_valid | 1 | Input | 指令有效信号，控制模块是否输出有效结果 |
| src_precision | 1 | Input | 源操作数精度选择：0=FP16, 1=FP32 |
| dst_precision | 1 | Input | 目标精度选择：0=FP16, 1=FP32 |
| dvr_fpmul_s0 | 32 | Input | 第一个操作数寄存器 |
| dvr_fpmul_s1 | 32 | Input | 第二个操作数寄存器 |
| dr_fpmul_d | 32 | Output | 乘法结果输出寄存器 |

### 2.3 操作数格式

#### FP16格式（IEEE 754 binary16）
- 符号位：bit[15]
- 指数位：bit[14:10]，5位，偏置值=15
- 尾数位：bit[9:0]，10位

#### FP32格式（IEEE 754 binary32）
- 符号位：bit[31]
- 指数位：bit[30:23]，8位，偏置值=127
- 尾数位：bit[22:0]，23位

## 3. 功能规格

### 3.1 基本运算功能
- **乘法运算**：计算两个浮点数的乘积 result = a × b
- **符号处理**：结果符号 = 操作数符号异或
- **指数处理**：结果指数 = 操作数指数之和（减去偏置）
- **尾数处理**：结果尾数 = 操作数尾数相乘

### 3.2 特殊值处理

#### 3.2.1 零值处理
- +0 × 任何有限数 = +0/-0（符号由异或确定）
- -0 × 任何有限数 = +0/-0（符号由异或确定）
- 0 × ∞ = NaN（无效操作）

#### 3.2.2 无穷大处理
- ∞ × 有限非零数 = ∞（符号由异或确定）
- ∞ × ∞ = ∞（符号由异或确定）
- ∞ × 0 = NaN（无效操作）

#### 3.2.3 NaN处理
- 任何操作数为NaN → 结果为NaN
- 无效操作（∞×0）→ 结果为NaN
- NaN传播：保持输入NaN的载荷信息

#### 3.2.4 非规格化数处理
- 输入非规格化数正确处理（隐含前导位为0）
- 输出非规格化数支持（指数下溢时产生）
- 渐进下溢（gradual underflow）支持

### 3.3 舍入机制

#### 3.3.1 舍入模式
- 默认采用IEEE 754标准的"舍入到最近偶数"（Round to Nearest Even）
- 当舍入位=0.5时，向最近的偶数舍入

#### 3.3.2 舍入位计算
- **Round bit**：被舍弃位的最高位
- **Sticky bit**：被舍弃位除最高位外的OR结果
- **舍入条件**：round_bit && (sticky_bit || LSB)

### 3.4 异常处理

#### 3.4.1 支持的异常类型
- **无效操作（Invalid）**：∞×0等无效运算
- **溢出（Overflow）**：结果指数超出表示范围
- **下溢（Underflow）**：结果指数小于最小规格化数指数
- **不精确（Inexact）**：结果需要舍入

#### 3.4.2 异常响应
- 溢出：返回无穷大（符号正确）
- 下溢：返回非规格化数或零
- 无效操作：返回NaN

## 4. 架构设计

### 4.1 FP16乘法器设计

#### 4.1.1 关键参数
- 数据位宽：16位
- 指数位宽：5位，偏置=15
- 尾数位宽：10位
- 尾数乘积位宽：22位

#### 4.1.2 处理流程
1. **输入解析**：提取符号、指数、尾数
2. **特殊值检测**：零、无穷大、NaN识别
3. **尾数乘法**：11位×11位=22位乘法
4. **规格化**：前导零计数和移位
5. **舍入处理**：IEEE 754舍入逻辑
6. **指数调整**：考虑规格化和舍入的指数修正
7. **结果组装**：符号、指数、尾数合并

### 4.2 FP32乘法器设计

#### 4.2.1 关键参数
- 数据位宽：32位
- 指数位宽：8位，偏置=127
- 尾数位宽：23位
- 尾数乘积位宽：48位

#### 4.2.2 处理流程
与FP16类似，但使用更大的位宽：
- 尾数乘法：24位×24位=48位
- 前导零计数：48位输入，6位输出

## 5. 性能规格

### 5.1 时序要求
- **组合逻辑设计**：单周期内完成计算
- **关键路径**：尾数乘法 → 前导零计数 → 舍入逻辑
- **建议工作频率**：根据具体工艺确定

### 5.2 面积估算
- **FP16乘法器**：约11×11位乘法器 + 控制逻辑
- **FP32乘法器**：约24×24位乘法器 + 控制逻辑

### 5.3 功耗特性
- **动态功耗**：主要来自尾数乘法器
- **静态功耗**：标准CMOS逻辑功耗
- **功耗优化**：可通过时钟门控实现

## 6. 文档交付

### 6.1 设计文档
- RTL源代码（fpmul.v, lzc.v）
- 测试台代码（tb_fpmul.v）
- DPI-C接口代码（softfloat_dpi.c）

### 6.2 验证文档
- 测试计划和用例
- 覆盖率报告
- 仿真日志和波形
- 验证总结报告

---

**文档版本**：V1.1  
**创建日期**：2025年6月28日  
**最后更新**：2025年7月14日  
