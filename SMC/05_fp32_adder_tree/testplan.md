# FP32加法器树验证测试计划

## 1. 引言

本测试计划针对8输入的FP32加法器树设计，详细规划了验证策略和测试用例，旨在全面验证设计的功能正确性和性能指标。

## 2. 设计概述

FP32加法器树是一个处理8个IEEE-754单精度浮点数输入，通过并行加法得到它们的和的硬件实现。设计包含以下核心组件：

- **fp32_unpacker**：拆解FP32输入为符号、指数和尾数，并检测特殊值（零、无穷、NaN）
- **fp32_aligner**：对输入数据进行指数对齐处理
- **wallace_tree_8_inputs**：实现高效的并行加法运算
- **fp32_normalizer_rounder**：执行规格化和舍入操作
- **fp32_packer**：将计算结果重新打包为FP32格式

## 3. 验证目标

1. **功能正确性**：验证加法器树能正确计算8个FP32输入的和
2. **特殊值处理**：确保正确处理NaN、无穷大、零等特殊值
3. **边界条件**：验证在数值边界条件下的正确行为
4. **IEEE-754合规性**：验证结果符合IEEE-754标准要求
5. **舍入精度**：验证舍入操作满足IEEE-754标准

## 4. 验证方法

### 4.1 仿真平台

使用SystemVerilog/Verilog测试平台，包含：
- 随机刺激生成
- 参考模型（使用浮点运算）
- 结果比较和检查机制
- 自动化测试框架

### 4.2 覆盖率收集

收集以下覆盖率指标：
- 代码覆盖率（行覆盖率、分支覆盖率、条件覆盖率）
- 功能覆盖率（特殊值组合、指数差范围、舍入情况等）

## 5. 测试场景

### 5.1 基本功能测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| BF-01 | 基本加法 | 8个随机正常数相加 | 结果等于软件计算的和 |
| BF-02 | 混合符号加法 | 混合正负数的加法 | 结果等于软件计算的和 |
| BF-03 | 同值加法 | 8个相同值相加 | 结果等于8倍的输入值 |
| BF-04 | 仅单输入有效 | 一个正常值，其余为零 | 结果等于该非零输入 |

+建议子测试用例：
+- BF-01.1: 输入顺序全排列（8! 组合）一致性验证。
+- BF-01.2: 极大/极小值混合随机输入测试。
+- BF-02.1: 多种正负比例（1正7负、2正6负、等）验证。
+- BF-03.1: 同值大范围（如最大值、最小值）测试。

### 5.2 特殊值测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| SP-01 | 全零输入 | 所有输入为零（包括正零和负零组合） | 根据IEEE规则输出正零或负零 |
| SP-02 | NaN处理 | 一个或多个输入为NaN | 输出NaN，is_nan_out=1 |
| SP-03 | 正无穷 | 一个输入为正无穷，其余为正常值 | 输出正无穷，is_inf_out=1 |
| SP-04 | 负无穷 | 一个输入为负无穷，其余为正常值 | 输出负无穷，is_inf_out=1 |
| SP-05 | 无穷冲突 | 同时有正无穷和负无穷输入 | 输出NaN，is_nan_out=1 |
| SP-06 | 无穷与NaN | 同时有无穷和NaN输入 | 输出NaN，is_nan_out=1 |
| SP-07 | 非规格化数与零混合 | 部分输入为最小非规格化数，部分为零 | 正确舍入/保留非规格化结果 |
| SP-08 | 混合+0/-0与非规格化 | +0、-0和非规格化数混合 | 符号和幅度正确处理 |
| SP-09 | 多种NaN类型 | 混合qNaN和sNaN输入 | 输出qNaN/保持NaN，is_nan_out=1 |
| SP-10 | 混合Inf与Denorm | Inf与最小非规格化数混合 | 输出Inf，is_inf_out=1 |

### 5.3 边界值测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| BV-01 | 最小非规格化数 | 8个最小非规格化数相加 | 正确的舍入结果 |
| BV-02 | 最大非规格化数 | 8个最大非规格化数相加 | 转为规格化数后的正确结果 |
| BV-03 | 最小规格化数 | 8个最小规格化数相加 | 正确的舍入结果 |
| BV-04 | 最大规格化数 | 多个最大规格化数相加 | 溢出为无穷，is_inf_out=1 |
| BV-05 | 接近上溢 | 接近但未达最大值的相加 | 根据舍入规则得到正确结果 |
| BV-06 | 接近下溢 | 接近但未达最小值的相加 | 根据舍入规则得到正确结果或非规格化数 |
| BV-07 | 最大指数差极限 | 指数差达到对齐移位上限 | 小值被完全舍弃或粘滞位正确设置 |
| BV-08 | 最小指数差极限 | 指数差为0（所有指数相同） | 对齐不改变尾数 |
| BV-09 | 尾数全1测试 | 所有尾数字段全1格化数输入 | 舍入和进位行为符合IEEE |
| BV-10 | 尾数全0测试 | 所有尾数字段全0正规数输入 | 避免不必要的规格化/舍入 |

### 5.4 舍入测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| RD-01 | 向偶数舍入 | 舍入位恰好是0.5，且LSB为0 | 向下舍入 |
| RD-02 | 向偶数舍入 | 舍入位恰好是0.5，且LSB为1 | 向上舍入 |
| RD-03 | 向上舍入进位 | 舍入后需要进位的情况 | 正确进位并调整指数 |
| RD-04 | 向下舍入 | 舍入位小于0.5的情况 | 向下舍入 |
| RD-05 | 向上舍入 | 舍入位大于0.5的情况 | 向上舍入 |

+建议子测试用例：
+- RD-01.1: GRS=100 时向偶舍入验证。
+- RD-02.1: GRS=101、110、111 不同组合舍入行为。
+- RD-03.1: 舍入进位导致指数溢出测试。
+- RD-05.1: 精度极限（尾数全1）舍入结果验证。

### 5.5 指数对齐测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| EA-01 | 大指数差 | 输入包含指数差很大的值 | 小值被正确对齐并舍入 |
| EA-02 | 最大指数 | 包含最大允许指数的输入 | 正确对齐其他输入 |
| EA-03 | 最小指数 | 包含最小指数的输入 | 正确对齐处理 |
| EA-04 | 混合指数 | 包含各种不同指数范围的输入 | 正确对齐到最大指数 |

+建议子测试用例：
+- EA-01.1: 对齐移位量超过限制时的粘滞位测试。
+- EA-02.1: 指数相等时无对齐验证。
+- EA-03.1: 指数为0（denorm）输入对齐验证。
+- EA-04.1: 多组指数混合时的中间对齐行为。

### 5.6 规格化测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| NM-01 | 需要左移规格化 | 计算结果需要左移规格化 | 正确左移并调整指数 |
| NM-02 | 需要右移规格化 | 计算结果需要右移规格化 | 正确右移并调整指数 |
| NM-03 | 结果为非规格化数 | 指数下溢为非规格化数 | 正确表示为非规格化数 |
| NM-04 | 结果刚好规格化 | 计算结果不需移位即规格化 | 保持不变 |

+建议子测试用例：
+- NM-01.1: 需要左移至最高位边界测试。
+- NM-02.1: 右移后粘滞位处理验证。
+- NM-03.1: 完全下溢至0测试。
+- NM-04.1: 恰好规范化不移位测试。

### 5.7 符号处理测试

| 测试ID | 测试场景 | 测试内容 | 预期结果 |
|--------|---------|---------|---------|
| SG-01 | 正负抵消为零 | 输入使总和为精确零 | 输出正零 |
| SG-02 | 负值占优 | 负值幅度大于正值 | 结果为负 |
| SG-03 | 正值占优 | 正值幅度大于负值 | 结果为正 |
| SG-04 | 符号边界 | 结果接近零的符号判断 | 符号确定正确 |

+建议子测试用例：
+- SG-01.1: +0/-0 混合精确零符号验证。
+- SG-02.1: 多正多负幅度差微小时符号正确性。
+- SG-03.1: 小量正值对大负值抵消结果符号。
+- SG-04.1: 接近0但非0时的符号判定。

### 5.8 性能与压力测试
- PT-01: 持续随机测试压力，运行数万次随机用例，监控仿真性能与资源占用
- PT-02: 大规模边界值组合测试，验证性能稳定性
- PT-03: 长时间运行测试，检查潜在的泄漏和性能衰退
- PT-04: 高负载下的错误注入测试，验证系统鲁棒性


## 6. 随机测试策略

### 6.1 随机测试方法

- **纯随机测试**：完全随机生成8个FP32输入
- **约束随机测试**：根据特定场景生成约束的随机输入
- **权重偏向测试**：对边界情况、特殊值分配更高权重

### 6.2 随机测试场景

| 测试ID | 场景类型 | 生成策略 | 测试次数 |
|--------|---------|---------|---------|
| RT-01 | 纯随机 | 完全随机FP32值 | 10,000次 |
| RT-02 | 边界偏向 | 偏向于边界值的随机数 | 5,000次 |
| RT-03 | 特殊值混合 | 特殊值与随机值混合 | 3,000次 |
| RT-04 | 指数差异大 | 随机生成指数差异大的输入 | 2,000次 |
| RT-05 | 舍入边界 | 生成需要精确舍入的输入 | 2,000次 |

## 7. 回归测试策略

- 维护一个测试集，包含所有发现的bug对应的测试用例
- 每次设计修改后运行完整的回归测试
- 重点关注之前出现问题的场景和边界条件

## 8. 验证环境搭建

### 8.1 工具要求

- RTL模拟器：ModelSim/VCS
- 代码覆盖率工具
- 波形查看器
- 自动比较脚本

### 8.2 验证流程

1. 编译RTL设计和测试平台
2. 运行仿真测试
3. 收集覆盖率数据
4. 分析结果并生成报告
5. 修复问题并进行回归测试

## 9. 预期验收标准

- 所有测试用例通过
- 代码覆盖率 > 95%
- 功能覆盖率 > 90%
- 特殊值处理 100% 符合IEEE-754
- 无任何已知功能缺陷



## 附录A: 关键功能覆盖点

| 覆盖组 | 覆盖点 | 描述 |
|-------|-------|-----|
| 指数对齐 | 指数差范围 | 覆盖不同的指数差情况 |
| 舍入操作 | 舍入边界 | 覆盖各种舍入情况 |
| 特殊值组合 | 输入组合 | 覆盖各种特殊值输入组合 |
| 符号处理 | 符号组合 | 覆盖不同符号组合情况 |
| 规格化 | 规格化移位 | 覆盖各种规格化移位情况 |
