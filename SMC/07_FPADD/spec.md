# 📘 子字并行浮点加法器设计规范 (spec.md)

> **版本**：v1.0  
> **覆盖**：FP16×8 / FP32×4，IEEE-754，四级流水线

## 1. 项目概述
实现 **128 位并行浮点加法器**，支持动态切换两种模式：  
- **FP16×8**（8 通道，每通道 16 bit）  
- **FP32×4**（4 通道，每通道 32 bit）  
设计遵循 IEEE-754 标准，支持所有特殊值（NaN、±Inf、±0、非规格化数）及向最近偶数舍入[4,9](@ref)。

## 2. 特性总览
| 特性 | 说明 |
|------|------|
| **精度模式** | 1 位 `mode_flag`：0=FP16×8，1=FP32×4 |
| **接口宽度** | 128 bit 输入 / 128 bit 输出 |
| **延迟** | 固定 4 拍流水线（取指、译码、执行、回写）[3,9](@ref) |
| **特殊值** | NaN、±Inf、±0、denorm 全支持 |
| **舍入模式** | 最近偶数（round-to-nearest-even） |
| **复位** | 异步低有效 `rst_n`，立即回到 `IDLE` |
| **验证** | SoftFloat DPI-C 黄金模型 |

## 3. 接口定义
```verilog

module fpadd #(

parameter PARAM_DR_FPADD_CNT = 4 // 保留兼容

)(

input wire clk, // 系统时钟

input wire rst_n, // 异步复位（低有效）

input wire [127:0] dvr_fpadd_s0, // 加数 A

input wire [127:0] dvr_fpadd_s1, // 加数 B

input wire inst_valid, // 指令有效信号（1：启动计算）

input wire mode_flag, // 0:FP16×8, 1:FP32×4

output reg [127:0] dr_fpadd_d, // 加法结果

output wire idle // 空闲标志（1：可接收新指令）

)
```
## 4. 状态机
| 状态   | 描述                     |
|--------|--------------------------|
| `IDLE` | 等待 `inst_valid` 上升沿 |
| `PROC` | 锁存输入，启动子模块计算 |
| `WAIT` | 等待计算完成             |
| `DONE` | 输出结果，下一拍返回 IDLE |

> **流水线说明**：  
> 四级流水线结构（取指、译码、执行、回写）确保固定延迟[3,9](@ref)。

## 5. 子模块划分
fpadd.v
├── subword_adder.v (128b → 8×FP16 或 4×FP32)
│ ├── fp16_adder.v (单通道 16-bit)
│ └── fp32_adder.v (单通道 32-bit)

### 5.1 subword_adder.v
- **功能**：根据 `mode_flag` 拆分 128 位数据 → 并行加法 → 拼接结果  
- **实例化策略**：
  - `mode_flag=0`：8×`fp16_adder`  
  - `mode_flag=1`：4×`fp32_adder`[2,6](@ref)  

### 5.2 fp16_adder.v（单通道 FP16）
| 字段   | 位宽 | 说明             |
|--------|------|------------------|
| `sign` | 1    | 符号位           |
| `exp`  | 5    | 指数（偏置 15）  |
| `frac` | 10   | 尾数（隐含 1 位） |

**关键路径**：

解析 → 2. 特殊值判定 → 3. 指数对齐 → 4. 加减 → 5. 规格化 → 6. 舍入 → 7. 溢出处理
- **舍入**：Round-to-nearest-even（含 sticky 位）[4](@ref)  
- **非规格化**：denorm+denorm→规格化，指数=1  
- **溢出处理**：指数≥31 → ±Inf[1,4](@ref)  

### 5.3 fp32_adder.v（单通道 FP32）
| 字段   | 位宽 | 说明               |
|--------|------|--------------------|
| `sign` | 1    | 符号位             |
| `exp`  | 8    | 指数（偏置 127）   |
| `frac` | 23   | 尾数（隐含 1 位）   |

> **同构设计**：  
> 与 `fp16_adder` 逻辑结构一致，仅位宽不同：  
> - 指数≥255 → ±Inf  
> - 尾数≥24 位，舍入位 0 位[4,9](@ref)  

## 6. 特殊值处理速查
| 输入组合        | 结果      | 备注               |
|-----------------|-----------|--------------------|
| NaN + *         | NaN       | 最高优先级         |
| ±Inf + ∓Inf     | NaN       | IEEE 冲突          |
| ±Inf + *        | ±Inf      | 符号同 Inf         |
| ±0 + ∓0         | +0        | IEEE 规定          |
| denorm + denorm | 规格化    | 可能进位[1,4](@ref) |

## 7. 验证与交付
| 项            | 内容                              |
|---------------|-----------------------------------|
| **黄金模型**  | SoftFloat-DPI (`fp16_add_softfloat`, `fp32_add_softfloat`) |
| **容差**      | ULP ≤ 1                           |
| **覆盖率**    | 行≥95%，分支≥90%，特殊值 100%     |
| **仿真脚本**  | `run_sim.sh`（VCS + Verdi）       |
| **日志**      | `fpadd_sim.log`（pass/fail 统计） |

> **验证方法**：  
> 边界条件检测（如极小值/极大值）、一致性检验（交换律/结合律）、仿真波形分析[7,8](@ref)。

## 8. 快速上手

复制完代码后直接运行./run_sim.sh即可(注意修改路径) 